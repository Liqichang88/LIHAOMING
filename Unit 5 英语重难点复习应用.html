<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unit 5 è‹±è¯­é‡éš¾ç‚¹å¤ä¹ åº”ç”¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .flashcard {
            min-height: 240px; 
            cursor: pointer;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            position: relative;
        }
        .flashcard-inner {
            position: absolute;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }
        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .flashcard-front {
            background-color: #4f46e5;
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
        }
        .flashcard-back {
            background-color: white;
            color: #1f2937;
            font-size: 1.5rem;
            font-weight: 600;
            transform: rotateY(180deg);
            border: 2px solid #4f46e5;
        }
        .tab-active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        /* Style for the custom input display (Applies to Grammar & Completion) */
        #grammar-quiz-display, #completion-quiz-display {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            line-height: 2.5rem; 
        }
        /* Reduced input width and margin for tighter spacing in Completion Quiz */
        #grammar-quiz-display input, #completion-quiz-display input {
            display: inline-block;
            width: 100px; 
            margin: 0 3px; 
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            padding: 2px 5px;
            background-color: #fffbeb; 
        }
        .blank {
            color: #f97316; /* Orange color for blanks */
        }
        
        /* Cloze Test Styles */
        .cloze-passage-text {
            font-size: 1.125rem; 
            line-height: 2.5rem; 
            text-align: justify;
            margin-top: 1rem;
        }
        
        /* Cloze Blank Container: Redefining to center the underline */
        .cloze-placeholder {
            display: inline-flex; 
            flex-direction: column;
            align-items: center;
            margin: 0 2px; 
            min-width: 60px; 
            box-sizing: content-box; 
            height: 2.5rem; 
            justify-content: center; 
            vertical-align: middle; 
            padding-top: 0; 
        }
        .cloze-number {
            font-weight: 700;
            color: #ef4444; 
            font-size: 0.8rem; 
            line-height: 1; 
            margin-bottom: 0.5rem; 
        }
        .cloze-underline {
            display: block;
            width: 100%;
            height: 1px;
            border-bottom: 2px dashed #374151; 
            margin-bottom: 0; 
        }

        /* Styles for making Cloze options strictly 4 per line, non-wrapping */
        .cloze-options-row {
            display: flex;
            justify-content: space-between; 
            flex-wrap: nowrap; 
            gap: 0.75rem; 
            margin-top: 0.5rem;
            overflow-x: auto; 
            padding-bottom: 0.25rem; 
        }
        /* Style for each individual option label */
        .cloze-options-row label {
            flex: 1; 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            
            /* Visual improvements */
            display: flex;
            align-items: center;
            justify-content: center; 
            text-align: center;
            font-weight: 500;
            min-height: 1.5rem; 
            padding: 0.25rem 0.25rem; 
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem; 
            background-color: #ffffff;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
        
        .cloze-options-row label:hover {
            border-color: #ef4444; 
            background-color: #fef2f2; 
        }
        
        /* Hide radio button bullet for cleaner appearance, relying on label click */
        .cloze-options-row label input[type="radio"] {
            display: none; 
        }

        /* Highlight the selected option */
        .cloze-options-row label input[type="radio"]:checked + span {
            color: #ef4444; 
            font-weight: 700;
        }
        
        /* Custom Switch CSS */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #4f46e5;
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* Phonics Breakdown style */
        .phonics-breakdown {
            font-size: 1.1rem;
            font-weight: 500;
            color: #d1d5db; /* Light gray text */
            margin-top: 0.5rem;
        }
        .phonics-breakdown span {
            padding: 2px 4px;
            margin: 0 1px;
            border-radius: 4px;
            background-color: #6366f1; /* Slightly lighter indigo background */
            font-weight: 700;
            color: white;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Header -->
    <header class="text-center mb-8">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">Unit 5 è‹±è¯­é‡éš¾ç‚¹å¤ä¹ åº”ç”¨</h1>
        <p class="text-gray-500 mt-1">How are the seasons different? (å­¦ä¹  & æµ‹è¯•å…¨è¦†ç›–)</p>
    </header>

    <!-- Navigation Tabs -->
    <div class="flex justify-center border-b border-gray-300 mb-8 sticky top-0 bg-white z-10 rounded-t-xl shadow-md overflow-x-auto">
        <button id="tab-vocab" onclick="showSection('vocab')" class="p-3 sm:px-6 text-lg transition duration-200 tab-active whitespace-nowrap">è¯æ±‡é—ªå¡</button>
        <button id="tab-sentences" onclick="showSection('sentences')" class="p-3 sm:px-6 text-lg transition duration-200 whitespace-nowrap">é‡ç‚¹å¥å­</button>
        <button id="tab-grammar" onclick="showSection('grammar')" class="p-3 sm:px-6 text-lg transition duration-200 whitespace-nowrap">è¯­æ³•è‡ªæµ‹</button>
        <button id="tab-reading" onclick="showSection('reading')" class="p-3 sm:px-6 text-lg transition duration-200 whitespace-nowrap">é˜…è¯»ç†è§£</button>
        <button id="tab-completion" onclick="showSection('completion')" class="p-3 sm:px-6 text-lg transition duration-200 whitespace-nowrap">å®Œå…¨å¡«ç©º</button>
        <button id="tab-cloze" onclick="showSection('cloze')" class="p-3 sm:px-6 text-lg transition duration-200 whitespace-nowrap">å®Œå½¢å¡«ç©º</button>
    </div>

    <main class="max-w-4xl w-full mx-auto">
        
        <!-- I. è¯æ±‡é—ªå¡ Section -->
        <section id="section-vocab" class="review-section">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">I. è¯æ±‡é—ªå¡ (ç‚¹å‡»å¡ç‰‡ç¿»é¢)</h2>
            
            <!-- Toggle Control and Counter -->
            <div class="flex justify-between items-center mb-4 p-4 bg-indigo-50 rounded-lg">
                <div class="flex items-center space-x-3">
                    <!-- Clarified interaction: it's a switch (å¼€å…³) -->
                    <span class="text-sm text-indigo-700">æ˜¾ç¤ºä¸­æ–‡ç¿»è¯‘ (å¼€å…³):</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="chinese-toggle" onchange="toggleChinese()" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <p class="text-sm text-indigo-700">å½“å‰è¿›åº¦: <span id="vocab-counter">1 / 34</span></p>
            </div>

            <div id="vocab-card-container" class="flashcard-container mb-6">
                <!-- Flashcard will be inserted here -->
            </div>
            
            <!-- Audio Status -->
            <p id="audio-status" class="text-sm mt-3 text-center min-h-[1.5rem] text-gray-500">ç‚¹å‡»è¯»éŸ³æŒ‰é’®æ’­æ”¾</p>
            
            <button onclick="nextVocab()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-300 mt-4">ä¸‹ä¸€ä¸ªè¯æ±‡</button>
        </section>

        <!-- II. é‡ç‚¹å¥å­ Section -->
        <section id="section-sentences" class="review-section hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">II. é‡ç‚¹å¥å­å›é¡¾ (å…ˆè¯´å‡ºè‹±æ–‡ï¼Œå†ç‚¹å‡»æ˜¾ç¤º)</h2>
            <div class="flex justify-between items-center mb-4 p-4 bg-emerald-50 rounded-lg">
                <p class="text-sm text-emerald-700">å½“å‰è¿›åº¦: <span id="sentence-counter">1 / 28</span></p>
                <button onclick="nextSentence()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-full shadow-md transition duration-300">ä¸‹ä¸€å¥</button>
            </div>

            <div class="p-6 bg-white rounded-xl shadow-lg border border-emerald-300">
                <p id="sentence-cn" class="text-xl text-gray-800 mb-4 font-medium"></p>
                <div id="sentence-en-container" class="border-t pt-4 mt-4 hidden">
                    <p class="text-sm text-gray-500 mb-2">è‹±æ–‡åŸå¥ (English Sentence):</p>
                    <p id="sentence-en" class="text-2xl font-bold text-emerald-700"></p>
                </div>
                <button id="sentence-reveal-btn" onclick="revealSentence()" class="mt-4 w-full bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">ç‚¹å‡»æ˜¾ç¤ºè‹±æ–‡åŸå¥</button>
            </div>
        </section>

        <!-- III. è¯­æ³•è‡ªæµ‹ Section -->
        <section id="section-grammar" class="review-section hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">III. è¯­æ³•è‡ªæµ‹ï¼šåŠ¨è¯ä¸‰å• & help sb. do sth.</h2>

            <div class="p-6 bg-yellow-50 rounded-xl shadow-lg border border-yellow-300 mb-6">
                <p class="text-lg text-yellow-800 mb-3 font-semibold">å½“å‰è¯­æ³•ç‚¹: <span id="grammar-rule"></span></p>
                <p id="grammar-cn" class="text-md text-gray-600"></p>
            </div>

            <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                <p class="text-xl text-gray-800 mb-4 font-medium">è¯·å¡«å†™æ­£ç¡®çš„å•è¯å®Œæˆå¥å­:</p>
                <div id="grammar-quiz-display">
                    <!-- Quiz sentence components will be rendered here -->
                </div>
                
                <p id="quiz-result" class="text-lg font-medium min-h-[30px] mt-4"></p>
                <div class="flex space-x-4 mt-4">
                    <button id="check-btn" onclick="checkGrammar()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">æäº¤ç­”æ¡ˆ</button>
                    <button onclick="nextGrammar()" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">è·³è¿‡/ä¸‹ä¸€é¢˜</button>
                </div>
            </div>
        </section>
        
        <!-- IV. é˜…è¯»ç†è§£ Section -->
        <section id="section-reading" class="review-section hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">IV. é˜…è¯»ç†è§£ (Reading Comprehension)</h2>

            <div class="p-6 bg-purple-50 rounded-xl shadow-lg border border-purple-300 mb-6">
                <p id="reading-title" class="text-xl text-purple-800 mb-3 font-bold"></p>
                <p id="reading-passage" class="text-lg text-gray-700 leading-relaxed"></p>
            </div>

            <div id="reading-questions-container" class="space-y-6">
                <!-- Questions injected here -->
            </div>

            <div class="flex space-x-4 mt-8">
                <button id="reading-check-btn" onclick="checkReading()" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">æäº¤é˜…è¯»ç­”æ¡ˆ</button>
                <button onclick="nextReading()" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">ä¸‹ä¸€ç¯‡é˜…è¯»</button>
            </div>
            <p id="reading-result" class="text-lg font-medium min-h-[30px] mt-4 text-center"></p>
        </section>

        <!-- V. å®Œå…¨å¡«ç©º Section -->
        <section id="section-completion" class="review-section hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">V. å®Œå…¨å¡«ç©º (Sentence Completion)</h2>

            <div class="p-6 bg-pink-50 rounded-xl shadow-lg border border-pink-300 mb-6">
                <p id="completion-cn" class="text-md text-gray-600 font-semibold"></p>
            </div>

            <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                <p class="text-xl text-gray-800 mb-4 font-medium">æ ¹æ®ä¸­æ–‡æç¤ºï¼Œå¡«å†™æ­£ç¡®çš„å•è¯å®Œæˆå¥å­:</p>
                <div id="completion-quiz-display">
                    <!-- Quiz sentence components will be rendered here -->
                </div>
                
                <p id="completion-result" class="text-lg font-medium min-h-[30px] mt-4"></p>
                <div class="flex space-x-4 mt-4">
                    <button id="completion-check-btn" onclick="checkCompletion()" class="flex-1 bg-pink-500 hover:bg-pink-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">æäº¤ç­”æ¡ˆ</button>
                    <button onclick="nextCompletion()" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">ä¸‹ä¸€é¢˜</button>
                </div>
            </div>
        </section>

        <!-- VI. å®Œå½¢å¡«ç©º Section (NEW) -->
        <section id="section-cloze" class="review-section hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">VI. å®Œå½¢å¡«ç©º (Cloze Test)</h2>

            <div class="p-6 bg-red-50 rounded-xl shadow-lg border border-red-300 mb-6">
                <p id="cloze-title" class="text-xl text-red-800 mb-3 font-bold"></p>
                <div id="cloze-passage" class="cloze-passage-text text-gray-700 mb-4">
                    <!-- Passage with blanks will be rendered here -->
                </div>
                <p class="text-sm text-gray-600">è¯·æ ¹æ®ä¸Šä¸‹æ–‡ï¼Œé€‰æ‹©ä¸‹æ–¹æœ€åˆé€‚çš„é€‰é¡¹å¡«å…¥ç©ºç™½å¤„ã€‚</p>
            </div>

            <div id="cloze-questions-container" class="space-y-6">
                <!-- Questions injected here -->
            </div>

            <div class="flex space-x-4 mt-8">
                <button id="cloze-check-btn" onclick="checkCloze()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">æäº¤å®Œå½¢å¡«ç©ºç­”æ¡ˆ</button>
                <button onclick="nextCloze()" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">ä¸‹ä¸€ç¯‡</button>
            </div>
            <p id="cloze-result" class="text-lg font-medium min-h-[30px] mt-4 text-center"></p>
        </section>

    </main>

    <script>
        // --- 1. Data Definitions ---
        // Added 'phonics' array for natural phonics breakdown
        const vocabularyData = [
            // Core Vocabulary - Added Phonics
            {en: "spring", phonetic: "sprÉªÅ‹", cn: "æ˜¥å¤©", phonics: ["s", "pr", "ing"]}, 
            {en: "warm", phonetic: "wÉ”Ërm", cn: "æ¸©æš–çš„", phonics: ["w", "arm"]}, 
            {en: "summer", phonetic: "sÊŒmÉ™r", cn: "å¤å¤©", phonics: ["su", "m", "mer"]},
            {en: "hot", phonetic: "hÉ‘Ët", cn: "ç‚çƒ­çš„", phonics: ["h", "ot"]}, 
            {en: "autumn", phonetic: "É”ËtÉ™m", cn: "ç§‹å¤©", phonics: ["au", "t", "umn"]}, 
            {en: "cool", phonetic: "kuËl", cn: "å‡‰çˆ½çš„", phonics: ["c", "oo", "l"]},
            {en: "winter", phonetic: "wÉªntÉ™r", cn: "å†¬å¤©", phonics: ["w", "in", "ter"]}, 
            {en: "cold", phonetic: "koÊŠld", cn: "å¯’å†·çš„", phonics: ["c", "old"]}, 
            {en: "parent", phonetic: "perÉ™nt", cn: "çˆ¶äº²æˆ–æ¯äº²", phonics: ["pa", "rent"]},
            {en: "season", phonetic: "siËzÉ™n", cn: "å­£èŠ‚", phonics: ["sea", "son"]}, 
            {en: "year", phonetic: "jÉªÉ™r", cn: "å¹´", phonics: ["y", "ear"]}, 
            {en: "grow", phonetic: "É¡roÊŠ", cn: "(ä½¿)ç”Ÿé•¿", phonics: ["gr", "ow"]},
            {en: "get", phonetic: "É¡et", cn: "å˜å¾—", phonics: ["g", "et"]}, 
            {en: "usually", phonetic: "juËÊ’uÉ™li", cn: "é€šå¸¸", phonics: ["u", "su", "all", "y"]}, 
            {en: "after", phonetic: "Ã¦ftÉ™r", cn: "åœ¨...ä¹‹å", phonics: ["af", "ter"]},
            {en: "fall", phonetic: "fÉ”Ël", cn: "è½ä¸‹", phonics: ["f", "all"]}, 
            {en: "turn", phonetic: "tÉœËrn", cn: "(ä½¿)å˜æˆ", phonics: ["t", "urn"]}, 
            {en: "often", phonetic: "É”ËfÉ™n", cn: "ç»å¸¸", phonics: ["of", "ten"]},
            {en: "snow", phonetic: "snoÊŠ", cn: "ä¸‹é›ª", phonics: ["sn", "ow"]}, 
            {en: "then", phonetic: "Ã°en", cn: "ç„¶å", phonics: ["th", "en"]}, 
            {en: "begin", phonetic: "bÉªÉ¡Éªn", cn: "å¼€å§‹", phonics: ["be", "gin"]},
            // Supplementary Vocabulary
            {en: "different", phonetic: "dÉªfrÉ™nt", cn: "ä¸åŒçš„", phonics: ["di", "ff", "er", "ent"]}, 
            {en: "caption", phonetic: "kÃ¦pÊƒÉ™n", cn: "æ–‡å­—è¯´æ˜", phonics: ["cap", "tion"]}, 
            {en: "kid", phonetic: "kÉªd", cn: "å­©å­", phonics: ["k", "id"]},
            {en: "take a trip", phonetic: "teÉªk É™ trÉªp", cn: "çŸ­é€”æ—…è¡Œ", phonics: ["t", "ake", "a", "tr", "ip"]}, 
            {en: "leaf (leaves)", phonetic: "liËf", cn: "æ ‘å¶", phonics: ["l", "eaf"]}, 
            {en: "change", phonetic: "tÊƒeÉªndÊ’", cn: "æ”¹å˜", phonics: ["ch", "ange"]},
            {en: "each", phonetic: "iËtÊƒ", cn: "æ¯ä¸ª", phonics: ["ea", "ch"]}, 
            {en: "favourite", phonetic: "feÉªvÉ™rÉªt", cn: "æœ€å–œæ¬¢çš„", phonics: ["fa", "vo", "ur", "ite"]}, 
            {en: "wait", phonetic: "weÉªt", cn: "ç­‰å¾…", phonics: ["w", "ait"]},
            {en: "until", phonetic: "ÊŒntÉªl", cn: "ç›´åˆ°", phonics: ["un", "til"]}, 
            {en: "outside", phonetic: "aÊŠtsaÉªd", cn: "åœ¨å¤–é¢", phonics: ["out", "side"]}, 
            {en: "weather", phonetic: "weÃ°É™r", cn: "å¤©æ°”", phonics: ["wea", "ther"]},
            {en: "activity", phonetic: "Ã¦ktÉªvÉ™ti", cn: "æ´»åŠ¨", phonics: ["ac", "tiv", "i", "ty"]}, 
            {en: "build", phonetic: "bÉªld", cn: "å»ºé€ ", phonics: ["b", "ui", "ld"]},
        ];

        const sentenceData = [
            {en: "There are four seasons in a year: spring, summer, autumn and winter.", cn: "ä¸€å¹´æœ‰å››å­£:æ˜¥å¤ç§‹å†¬ã€‚"},
            {en: "Plants grow in spring.", cn: "æ¤ç‰©åœ¨æ˜¥å¤©ç”Ÿé•¿ã€‚"},
            {en: "Spring is a season for growing. It gets warm. It usually rains a lot.", cn: "æ˜¥å¤©æ˜¯ç”Ÿé•¿çš„å­£èŠ‚ã€‚å¤©å˜æš–äº†ã€‚å¤©æ°”é€šå¸¸ä¸‹å¾ˆå¤šé›¨ã€‚"},
            {en: "The rain helps plants grow.", cn: "é›¨æ°´å¸®åŠ©æ¤ç‰©ç”Ÿé•¿ã€‚"},
            {en: "Summer comes after spring. It gets hot. The days are long and nights are short.", cn: "å¤å¤©åœ¨æ˜¥å¤©ä¹‹ååˆ°æ¥ã€‚å¤©å˜çƒ­äº†ã€‚å¤å¤©ç™½å¤©å¾ˆé•¿æ™šä¸Šå¾ˆçŸ­ã€‚"},
            {en: "The sun helps fruit and flowers grow.", cn: "å¤ªé˜³å¸®åŠ©æœå®å’ŒèŠ±æœµç”Ÿé•¿ã€‚"},
            {en: "Autumn comes after summer. It gets cool. Leaves fall down.", cn: "ç§‹å¤©åœ¨å¤å¤©ä¹‹ååˆ°æ¥ã€‚å¤©å˜å‡‰å¿«äº†ã€‚æ ‘å¶å‡‹è½ã€‚"},
            {en: "Leaves turn red, yellow and orange.", cn: "æ ‘å¶å˜çº¢ã€å˜é»„æˆ–å˜æ©™è‰²ã€‚"},
            {en: "Winter comes after autumn. It gets cold and it often snows!", cn: "å†¬å¤©åœ¨ç§‹å¤©ä¹‹ååˆ°æ¥ã€‚å¤©å˜å†·å¹¶ä¸”ç»å¸¸ä¸‹é›ª!"},
            {en: "The days are short and the nights are long.", cn: "å†¬å¤©ç™½å¤©å¾ˆçŸ­æ™šä¸Šå¾ˆé•¿ã€‚"},
            {en: "Many trees don't have leaves.", cn: "è®¸å¤šæ ‘æ²¡äº†æ ‘å¶ã€‚"},
            {en: "The seasons begin again.", cn: "å››å­£(å¾ªç¯)åˆå¼€å§‹äº†ã€‚"},
            // Extend Sentences (P50)
            {en: "I have an apple tree.", cn: "æˆ‘æœ‰ä¸€é¢—è‹¹æœæ ‘ã€‚"},
            {en: "There are lots of flowers on my apple tree.", cn: "æˆ‘çš„è‹¹æœæ ‘ä¸Šæœ‰å¤§é‡çš„èŠ±ã€‚"},
            {en: "Honeybees look for food.", cn: "èœœèœ‚å¯»æ‰¾é£Ÿç‰©ã€‚"},
            {en: "I build a tree house in my apple tree.", cn: "æˆ‘åœ¨æˆ‘çš„è‹¹æœæ ‘ä¸Šå»ºé€ äº†ä¸€åº§æ ‘å±‹ã€‚"},
            {en: "I watch small apples grow.", cn: "æˆ‘è§‚çœ‹å°è‹¹æœçš„ç”Ÿé•¿ã€‚"},
            {en: "My apple tree now has big, red apples.", cn: "æˆ‘çš„è‹¹æœæ ‘ç°åœ¨ç»“äº†æœ‰å¤§åˆçº¢çš„è‹¹æœã€‚"},
            {en: "My family and I make apple pies.", cn: "æˆ‘çš„å®¶äººå’Œæˆ‘ä¸€èµ·åˆ¶ä½œè‹¹æœæ´¾ã€‚"},
            {en: "There is lots of snow.", cn: "(åœ°ä¸Š)æœ‰å¥½å¤šçš„é›ªã€‚"},
            {en: "I make a snowman.", cn: "æˆ‘åšäº†ä¸ªé›ªäººã€‚"},
            {en: "There are no leaves on the apple tree now.", cn: "è‹¹æœæ ‘ä¸Šç°åœ¨æ²¡æœ‰æ ‘å¶äº†ã€‚"},
        ];

        const grammarQuizData = [
            // help sb. do sth. tests
            { type: 'help', sentence: ["The sun helps fruit and flowers", "[verb_base]", "."], blanks: [{ base: "grow", correct: "grow"}], cn: "å¤ªé˜³å¸®åŠ©æœå®å’ŒèŠ±æœµç”Ÿé•¿ã€‚", rule: "åŠ¨è¯ä¸å®šå¼çœç•¥ to: help sb./sth. do sth." },
            { type: 'help', sentence: ["The rain", "[verb_s]", "plants", "[verb_base]", "."], blanks: [{ base: "help", correct: "helps"}, { base: "grow", correct: "grow"}], cn: "é›¨æ°´å¸®åŠ©æ¤ç‰©ç”Ÿé•¿ã€‚", rule: "åŠ¨è¯ä¸å®šå¼çœç•¥ to: help sb./sth. do sth." },
            { type: 'help', sentence: ["My mother always helps me", "[verb_base]", "my homework."], blanks: [{ base: "do", correct: "do"}], cn: "æˆ‘å¦ˆå¦ˆæ€»æ˜¯å¸®åŠ©æˆ‘åšæˆ‘çš„ä½œä¸šã€‚", rule: "åŠ¨è¯ä¸å®šå¼çœç•¥ to: help sb./sth. do sth." },
            
            // Third Person Singular tests
            { type: 'tps', sentence: ["It", "[verb_tps]", "warm in spring."], blanks: [{ base: "get", correct: "gets"}], cn: "å®ƒåœ¨æ˜¥å¤©å˜å¾—æ¸©æš–ã€‚", rule: "ç¬¬ä¸‰äººç§°å•æ•°: ä¸€èˆ¬æƒ…å†µåŠ  -s" },
            { type: 'tps', sentence: ["She", "[verb_tps]", "TV every day."], blanks: [{ base: "watch", correct: "watches"}], cn: "å¥¹æ¯å¤©çœ‹ç”µè§†ã€‚", rule: "ç¬¬ä¸‰äººç§°å•æ•°: ä»¥ ch ç»“å°¾åŠ  -es" },
            { type: 'tps', sentence: ["He", "[verb_tps]", "to school."], blanks: [{ base: "go", correct: "goes"}], cn: "ä»–å»å­¦æ ¡ã€‚", rule: "ç¬¬ä¸‰äººç§°å•æ•°: éƒ¨åˆ†ä»¥ -o ç»“å°¾åŠ  -es" },
            { type: 'tps', sentence: ["The sun", "[verb_tps]", "brightly in summer."], blanks: [{ base: "shine", correct: "shines"}], cn: "å¤ªé˜³åœ¨å¤å¤©ç…§è€€å¾—å¾ˆæ˜äº®ã€‚", rule: "ç¬¬ä¸‰äººç§°å•æ•°: ä¸€èˆ¬æƒ…å†µåŠ  -s" },
            { type: 'tps', sentence: ["My sister", "[verb_tps]", "English hard."], blanks: [{ base: "study", correct: "studies"}], cn: "æˆ‘å¦¹å¦¹åŠªåŠ›å­¦ä¹ è‹±è¯­ã€‚", rule: "ç¬¬ä¸‰äººç§°å•æ•°: è¾…éŸ³+y ç»“å°¾, æ”¹ y ä¸º i åŠ  -es" },
            { type: 'tps', sentence: ["Tom", "[verb_tps]", "his homework."], blanks: [{ base: "do", correct: "does"}], cn: "Tomåšä»–çš„ä½œä¸šã€‚", rule: "ç¬¬ä¸‰äººç§°å•æ•°: éƒ¨åˆ†ä»¥ -o ç»“å°¾åŠ  -es" },
            { type: 'tps', sentence: ["The cat", "[verb_tps]", "mice."], blanks: [{ base: "catch", correct: "catches"}], cn: "è¿™åªçŒ«æŠ“è€é¼ ã€‚", rule: "ç¬¬ä¸‰äººç§°å•æ•°: ä»¥ ch ç»“å°¾åŠ  -es" },
            { type: 'tps', sentence: ["Rosa", "[verb_tps]", "a lovely cow."], blanks: [{ base: "have", correct: "has"}], cn: "Rosaæœ‰ä¸€å¤´å¯çˆ±çš„ç‰›ã€‚", rule: "ç¬¬ä¸‰äººç§°å•æ•°: ç‰¹æ®Šå˜åŒ–" },
        ];
        
        const readingQuizData = [
            {
                title: "Passage 1: A Year on the Farm (å†œåœºçš„ä¸€å¹´)",
                text: "My family lives on a small farm. There are four seasons here, and each one is different. In spring, it gets warm, and we plant seeds. The rain helps them grow. Summer is hot and long, and we often take a trip to the lake for a swim. In autumn, it gets cool. The leaves turn yellow and fall down. Winter is cold and short. When it snows, my little kid and I build a big snowman outside. Then, the seasons begin again.",
                questions: [
                    {
                        q: "What activity do they usually do in the summer?",
                        options: ["Plant seeds.", "Build a snowman.", "Take a trip to the lake.", "Watch the leaves fall."],
                        correct: 2, // Take a trip to the lake.
                    },
                    {
                        q: "What season is cool and sees leaves falling?",
                        options: ["Spring", "Summer", "Autumn", "Winter"],
                        correct: 2, // Autumn.
                    },
                    {
                        q: "According to the passage, what helps the seeds grow?",
                        options: ["The sun.", "The snow.", "The rain.", "The lake."],
                        correct: 2, // The rain.
                    }
                ]
            },
            {
                title: "Passage 2: My Favorite Season (æˆ‘æœ€çˆ±çš„å­£èŠ‚)",
                text: "My favourite season is spring. It is very different from winter because the weather is warm and everything begins to grow. I usually go outside and wait for the flowers to open. After spring, summer comes. It is too hot to play sports. I don't like winter much because it is too cold and often snows. The days are short then. I like to change my activity when the season changes. I always look forward to the year starting fresh in the spring.",
                questions: [
                    {
                        q: "What is the author's favourite season?",
                        options: ["Summer", "Winter", "Spring", "Autumn"],
                        correct: 2, // Spring.
                    },
                    {
                        q: "Why does the author dislike winter?",
                        options: ["It is too hot.", "It is too cold and snows.", "The days are long.", "He has no activity."],
                        correct: 1, // It is too cold and snows.
                    },
                    {
                        q: "What does the author do after spring?",
                        options: ["He waits for flowers.", "He plays sports.", "The weather gets hot.", "He changes his activity."],
                        correct: 2, // The weather gets hot (Summer comes, It is too hot)
                    }
                ]
            }
        ];

        const completionQuizData = [
            {
                cn: "ä¸€å¹´æœ‰å››ä¸ªå­£èŠ‚ã€‚",
                en_parts: ["There are four", "[season]", "in a", "[year]", "."],
                blanks: [{ correct: "seasons" }, { correct: "year" }]
            },
            {
                cn: "ä¸‹é›ªäº†ï¼Œå¤©æ°”å¾ˆå†·ã€‚",
                en_parts: ["It", "[snow]", "and it's very", "[cold]", "."],
                blanks: [{ correct: "snows" }, { correct: "cold" }]
            },
            {
                cn: "æˆ‘çš„æ¯äº²é€šå¸¸åœ¨å‘¨æœ«å¸¦æˆ‘ä»¬å»çŸ­é€”æ—…è¡Œã€‚",
                en_parts: ["My mother", "[usually]", "takes us for a", "[trip]", "on weekends."],
                blanks: [{ correct: "usually" }, { correct: "trip" }] 
            },
            {
                cn: "åœ¨ç§‹å¤©ï¼Œæ ‘å¶ä¼šå˜è‰²ã€‚",
                en_parts: ["The", "[leaf]", "will", "[change]", "color in", "[autumn]", "."],
                blanks: [{ correct: "leaves" }, { correct: "change" }, { correct: "autumn" }]
            },
            {
                cn: "é›¨æ°´å¸®åŠ©æ¤ç‰©ç”Ÿé•¿ã€‚",
                en_parts: ["The rain", "[help]", "plants", "[grow]", "."],
                blanks: [{ correct: "helps" }, { correct: "grow" }]
            },
            {
                cn: "ä»–åœ¨å¤–é¢ç­‰æˆ‘ï¼Œç›´åˆ°æˆ‘å®Œæˆä½œä¸šã€‚",
                en_parts: ["He is waiting", "[outside]", "[until]", "I finish my homework."],
                blanks: [{ correct: "outside" }, { correct: "until" }] 
            },
            {
                cn: "å†¬å¤©ä¹‹åæ˜¥å¤©å°±æ¥äº†ã€‚",
                en_parts: ["Spring", "[come]", "[after]", "winter."],
                blanks: [{ correct: "comes" }, { correct: "after" }] 
            },
        ];

        // --- CLOZE DATA (VI) ---
        const clozeQuizData = [
            {
                title: "Apple Tree Seasons (è‹¹æœæ ‘å››å­£)",
                textParts: [
                    "My favorite season is spring. I have an apple tree. In spring, the weather is",
                    "warm", // 1
                    "and there are lots of flowers on my tree. Honeybees look for food, and the rain",
                    "helps", // 2
                    "the plants to grow.\n\nAfter spring,", // <-- \n\n creates paragraph break
                    "summer", // 3
                    "comes. It is very hot and the days are long. I like to sit",
                    "outside", // 4
                    "and watch the small apples",
                    "grow", // 5
                    "bigger. My family and I will take a trip to the lake one day.\n\nThen it is autumn. The days", // <-- \n\n creates paragraph break
                    "get", // 6
                    "cool. The leaves",
                    "fall", // 7
                    "down, and they",
                    "turn", // 8
                    "red or yellow. After autumn,",
                    "winter", // 9
                    "comes. It is very",
                    "cold", // 10
                    "and it often snows! I build a snowman with my kid. Then, the seasons begin again."
                ],
                questions: [
                    { qIndex: 1, options: ["cool", "cold", "hot", "warm"], correct: 3 }, // warm
                    { qIndex: 2, options: ["grows", "helps", "takes", "falls"], correct: 1 }, // helps
                    { qIndex: 3, options: ["autumn", "winter", "summer", "season"], correct: 2 }, // summer
                    { qIndex: 4, options: ["usually", "often", "outside", "until"], correct: 2 }, // outside
                    { qIndex: 5, options: ["grow", "to grow", "growing", "grew"], correct: 0 }, // grow (help sb do sth)
                    { qIndex: 6, options: ["get", "gets", "got", "getting"], correct: 0 }, // get (The days get cool)
                    { qIndex: 7, options: ["change", "turn", "grow", "fall"], correct: 3 }, // fall
                    { qIndex: 8, options: ["turn", "turns", "change", "changes"], correct: 0 }, // turn (The leaves... turn)
                    { qIndex: 9, options: ["winter", "summer", "spring", "season"], correct: 0 }, // winter
                    { qIndex: 10, options: ["warm", "cool", "hot", "cold"], correct: 3 }, // cold
                ]
            }
        ];

        
        // --- 2. State Variables ---
        let currentVocabIndex = 0;
        let isVocabFlipped = false;
        let showChineseTranslation = true; // æ–°å¢çŠ¶æ€ï¼šæ§åˆ¶ä¸­æ–‡ç¿»è¯‘æ˜¾ç¤º
        let currentSentenceIndex = 0;
        let currentGrammarIndex = 0;
        let currentReadingIndex = 0;
        let currentCompletionIndex = 0;
        let currentClozeIndex = 0; 

        // Shuffle quiz data for variety
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        shuffleArray(grammarQuizData);
        shuffleArray(completionQuizData);
        shuffleArray(clozeQuizData);

        // --- TTS Utility Functions (Text-to-Speech) ---
        
        const apiKey = "";
        const ttsModel = "gemini-2.5-flash-preview-tts";
        const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${ttsModel}:generateContent?key=${apiKey}`;

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function pcmToWav(pcm16, sampleRate = 16000) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            
            const wavLength = 44 + pcm16.byteLength;
            const buffer = new ArrayBuffer(wavLength);
            const view = new DataView(buffer);
            
            // RIFF identifier
            writeString(view, 0, 'RIFF');
            // File size
            view.setUint32(4, wavLength - 8, true);
            // WAV identifier
            writeString(view, 8, 'WAVE');
            // FMT chunk
            writeString(view, 12, 'fmt ');
            // FMT chunk size
            view.setUint32(16, 16, true);
            // Audio format (1 = PCM)
            view.setUint16(20, 1, true);
            // Number of channels
            view.setUint16(22, numChannels, true);
            // Sample rate
            view.setUint32(24, sampleRate, true);
            // Byte rate
            view.setUint32(28, byteRate, true);
            // Block align
            view.setUint16(32, blockAlign, true);
            // Bits per sample
            view.setUint16(34, bitsPerSample, true);
            // Data chunk
            writeString(view, 36, 'data');
            // Data size
            view.setUint32(40, pcm16.byteLength, true);
            
            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }
            
            return new Blob([buffer], { type: 'audio/wav' });
        }

        function playWavAudio(wavBlob) {
            const audioUrl = URL.createObjectURL(wavBlob);
            const audio = new Audio(audioUrl);
            audio.play().catch(e => console.error("Error playing audio:", e));
        }

        async function playAudio(text, voiceName = "Zephyr") {
            const statusEl = document.getElementById('audio-status');
            statusEl.textContent = 'ğŸ”Š æ­£åœ¨ç”Ÿæˆè¯»éŸ³...';
            statusEl.classList.remove('text-red-500', 'text-green-500', 'text-gray-500');
            statusEl.classList.add('text-indigo-500');

            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voiceName } } }
                },
                model: ttsModel
            };

            let response;
            for (let i = 0; i < 3; i++) {
                try {
                    response = await fetch(ttsApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) break;
                } catch (error) {
                    if (i < 2) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    } else {
                        console.error('API call failed after multiple retries:', error);
                        statusEl.textContent = 'âŒ è¯»éŸ³ç”Ÿæˆå¤±è´¥ (API Error)';
                        statusEl.classList.replace('text-indigo-500', 'text-red-500');
                        return;
                    }
                }
            }

            if (!response || !response.ok) {
                statusEl.textContent = 'âŒ è¯»éŸ³ç”Ÿæˆå¤±è´¥ (Server Error)';
                statusEl.classList.replace('text-indigo-500', 'text-red-500');
                return;
            }

            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                try {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    playWavAudio(wavBlob);
                    
                    statusEl.textContent = 'âœ… æ­£åœ¨æ’­æ”¾...';
                    statusEl.classList.replace('text-indigo-500', 'text-green-500');
                    
                    setTimeout(() => {
                        statusEl.textContent = 'ç‚¹å‡»è¯»éŸ³æŒ‰é’®æ’­æ”¾';
                        statusEl.classList.remove('text-green-500');
                        statusEl.classList.add('text-gray-500');
                    }, 3000);

                } catch (e) {
                    console.error("Audio processing error:", e);
                    statusEl.textContent = 'âŒ è¯»éŸ³å¤„ç†é”™è¯¯';
                    statusEl.classList.replace('text-indigo-500', 'text-red-500');
                }
            } else {
                statusEl.textContent = 'âŒ æ— æ³•è·å–è¯»éŸ³æ•°æ®';
                statusEl.classList.replace('text-indigo-500', 'text-red-500');
            }
        }


        // --- 3. UI Control Functions ---

        function showSection(sectionId) {
            document.querySelectorAll('.review-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(`section-${sectionId}`).classList.remove('hidden');

            document.querySelectorAll('button[id^="tab-"]').forEach(tab => {
                tab.classList.remove('tab-active');
            });
            document.getElementById(`tab-${sectionId}`).classList.add('tab-active');

            if (sectionId === 'vocab') {
                renderVocabCard();
            } else if (sectionId === 'sentences') {
                renderSentence();
            } else if (sectionId === 'grammar') {
                renderGrammarQuiz();
            } else if (sectionId === 'reading') {
                renderReadingQuiz();
            } else if (sectionId === 'completion') {
                renderCompletionQuiz();
            } else if (sectionId === 'cloze') {
                renderClozeQuiz();
            }
        }

        // --- 4. Vocabulary Flashcard Logic ---

        function toggleChinese() {
            // Read the checked state of the toggle switch
            showChineseTranslation = document.getElementById('chinese-toggle').checked;
            renderVocabCard(); // Re-render the card to apply the visibility change
        }

        function renderVocabCard() {
            const container = document.getElementById('vocab-card-container');
            const data = vocabularyData[currentVocabIndex];
            
            // Generate phonics breakdown HTML
            const phonicsHtml = data.phonics.map(p => `<span>${p}</span>`).join('');

            // Update counter
            document.getElementById('vocab-counter').textContent = `${currentVocabIndex + 1} / ${vocabularyData.length}`;

            // Create card HTML
            container.innerHTML = `
                <div id="vocab-card" class="flashcard ${isVocabFlipped ? 'flipped' : ''}" onclick="flipVocab()">
                    <div class="flashcard-inner">
                        <div class="flashcard-front">
                            <!-- Front Content: English word, phonetic, and play button -->
                            <div class="flex flex-col items-center p-4">
                                <span class="text-3xl font-bold mb-1">${data.en}</span>
                                <span class="text-xl font-medium mb-1 text-white/80">[${data.phonetic}]</span>
                                <!-- Phonics Breakdown -->
                                <div class="phonics-breakdown flex justify-center flex-wrap">${phonicsHtml}</div>
                                
                                <button onclick="event.stopPropagation(); playAudio('${data.en}')" 
                                        class="bg-white text-indigo-600 hover:bg-indigo-100 py-2 px-4 rounded-full shadow-md transition duration-300 flex items-center space-x-2 mt-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                    </svg>
                                    <span>è¯»éŸ³</span>
                                </button>
                            </div>
                        </div>
                        <div class="flashcard-back">
                            <!-- Back Content: English word, phonetic, and conditional Chinese -->
                            <div class="flex flex-col items-center p-4">
                                <span class="text-3xl font-bold mb-2 text-indigo-600">${data.en}</span>
                                <span class="text-xl font-medium mb-4 text-gray-700">[${data.phonetic}]</span>
                                <!-- CRITICAL: Conditional rendering for Chinese translation -->
                                ${showChineseTranslation ? 
                                    // SHOW Chinese translation (data.cn)
                                    `<span class="text-2xl font-bold text-gray-800 border-t pt-4 mt-4 w-full">${data.cn}</span>` : 
                                    // SHOW placeholder message
                                    `<span class="text-lg font-semibold text-gray-500 border-t pt-4 mt-4 w-full">ä¸­æ–‡ç¿»è¯‘å·²éšè— (è¯·ç‚¹å‡»ä¸Šæ–¹å¼€å…³æ˜¾ç¤º)</span>`
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Ensure the toggle switch state is visually correct (optional but safe)
            document.getElementById('chinese-toggle').checked = showChineseTranslation;
        }

        function flipVocab() {
            const card = document.getElementById('vocab-card');
            isVocabFlipped = !isVocabFlipped;
            if (isVocabFlipped) {
                card.classList.add('flipped');
            } else {
                card.classList.remove('flipped');
            }
        }

        function nextVocab() {
            isVocabFlipped = false;
            currentVocabIndex = (currentVocabIndex + 1) % vocabularyData.length;
            renderVocabCard();
        }

        // --- 5. Sentence Review Logic ---

        function renderSentence() {
            const data = sentenceData[currentSentenceIndex];
            
            // Update counter
            document.getElementById('sentence-counter').textContent = `${currentSentenceIndex + 1} / ${sentenceData.length}`;

            // Reset state
            document.getElementById('sentence-cn').textContent = data.cn;
            document.getElementById('sentence-en').textContent = data.en;
            document.getElementById('sentence-en-container').classList.add('hidden');
            document.getElementById('sentence-reveal-btn').textContent = "ç‚¹å‡»æ˜¾ç¤ºè‹±æ–‡åŸå¥";
            document.getElementById('sentence-reveal-btn').classList.remove('bg-gray-500');
            document.getElementById('sentence-reveal-btn').classList.add('bg-emerald-500');
        }

        function revealSentence() {
            document.getElementById('sentence-en-container').classList.remove('hidden');
            document.getElementById('sentence-reveal-btn').textContent = "å·²æ˜¾ç¤º - ç‚¹å‡»ä¸‹ä¸€å¥";
            document.getElementById('sentence-reveal-btn').classList.remove('bg-emerald-500');
            document.getElementById('sentence-reveal-btn').classList.add('bg-gray-500');
            document.getElementById('sentence-reveal-btn').onclick = nextSentence;
        }
        
        function nextSentence() {
            currentSentenceIndex = (currentSentenceIndex + 1) % sentenceData.length;
            document.getElementById('sentence-reveal-btn').onclick = revealSentence;
            renderSentence();
        }

        // --- 6. Grammar Quiz Logic (III) ---

        function renderGrammarQuiz() {
            const data = grammarQuizData[currentGrammarIndex];
            const quizDisplay = document.getElementById('grammar-quiz-display');
            
            // Display rule hint and CN hint
            document.getElementById('grammar-rule').textContent = data.rule;
            document.getElementById('grammar-cn').textContent = `ä¸­æ–‡: ${data.cn}`;
            
            // Build the sentence display with blanks
            let html = '';
            let blankCounter = 0;

            data.sentence.forEach(part => {
                if (part.startsWith('[')) {
                    // It's a blank
                    const baseWord = data.blanks[blankCounter].base;
                    
                    html += `
                        <input type="text" 
                                class="border-2 border-gray-300 p-2 rounded-lg text-center focus:border-orange-500 focus:ring-0 blank" 
                                placeholder="è¾“å…¥ ${baseWord}" 
                                value="">
                    `;
                    blankCounter++;
                } else {
                    // It's regular text
                    html += `<span>${part}</span>`;
                }
            });
            
            quizDisplay.innerHTML = html;
            document.getElementById('quiz-result').innerHTML = '';
            document.getElementById('check-btn').style.display = 'block';

            // Re-enable inputs
            quizDisplay.querySelectorAll('input').forEach(input => {
                input.disabled = false;
                input.classList.remove('border-green-500', 'border-red-500');
            });
        }

        function checkGrammar() {
            const data = grammarQuizData[currentGrammarIndex];
            const quizDisplay = document.getElementById('grammar-quiz-display');
            const inputs = quizDisplay.querySelectorAll('input');
            const result = document.getElementById('quiz-result');
            let allCorrect = true;

            inputs.forEach((input, index) => {
                const userAnswer = input.value.trim().toLowerCase();
                const correctWord = data.blanks[index].correct.toLowerCase();
                
                input.disabled = true;

                if (userAnswer === correctWord) {
                    input.classList.add('border-green-500');
                    input.classList.remove('border-red-500');
                } else {
                    input.classList.add('border-red-500');
                    input.classList.remove('border-green-500');
                    allCorrect = false;
                }
            });
            
            // Construct and display the full correct sentence
            let sentenceParts = [];
            let inputIndex = 0;
            data.sentence.forEach(part => {
                if (part.startsWith('[')) {
                    sentenceParts.push(data.blanks[inputIndex].correct);
                    inputIndex++;
                } else {
                    sentenceParts.push(part);
                }
            });
            
            const fullCorrectSentence = sentenceParts.join(' ');


            if (allCorrect) {
                result.innerHTML = `<span class="text-green-600">âœ… å…¨éƒ¨æ­£ç¡®ï¼</span> å®Œæ•´å¥å­ï¼š${fullCorrectSentence}`;
            } else {
                result.innerHTML = `<span class="text-red-600">âŒ å­˜åœ¨é”™è¯¯ã€‚</span> æ­£ç¡®å¥å­: ${fullCorrectSentence}`;
            }

            document.getElementById('check-btn').style.display = 'none';
        }

        function nextGrammar() {
            currentGrammarIndex = (currentGrammarIndex + 1) % grammarQuizData.length;
            renderGrammarQuiz();
        }

        // --- 7. Reading Comprehension Logic (IV) ---

        function renderReadingQuiz() {
            const data = readingQuizData[currentReadingIndex];
            document.getElementById('reading-title').textContent = data.title;
            document.getElementById('reading-passage').innerHTML = data.text;
            document.getElementById('reading-result').textContent = '';
            document.getElementById('reading-check-btn').style.display = 'block';

            const questionsContainer = document.getElementById('reading-questions-container');
            let html = '';

            data.questions.forEach((qItem, qIndex) => {
                html += `
                    <div class="p-4 bg-white rounded-lg shadow-sm border border-purple-200">
                        <p class="font-bold mb-3 text-gray-800">${qIndex + 1}. ${qItem.q}</p>
                        <div class="space-y-2">
                `;
                qItem.options.forEach((option, oIndex) => {
                    html += `
                        <label class="flex items-center space-x-2 text-gray-700 cursor-pointer">
                            <input type="radio" name="q${qIndex}" value="${oIndex}" class="text-purple-600 focus:ring-purple-500" data-qindex="${qIndex}">
                            <span>${String.fromCharCode(65 + oIndex)}. ${option}</span>
                        </label>
                    `;
                });
                html += `
                        </div>
                        <p id="q-result-${qIndex}" class="mt-2 text-sm font-semibold"></p>
                    </div>
                `;
            });

            questionsContainer.innerHTML = html;
        }

        function checkReading() {
            const data = readingQuizData[currentReadingIndex];
            let score = 0;
            let total = data.questions.length;

            data.questions.forEach((qItem, qIndex) => {
                const selected = document.querySelector(`input[name="q${qIndex}"]:checked`);
                const resultEl = document.getElementById(`q-result-${qIndex}`);
                
                if (selected) {
                    const userAnswer = parseInt(selected.value);
                    if (userAnswer === qItem.correct) {
                        score++;
                        resultEl.innerHTML = '<span class="text-green-600">âœ… æ­£ç¡®</span>';
                    } else {
                        const correctOption = String.fromCharCode(65 + qItem.correct);
                        resultEl.innerHTML = `<span class="text-red-600">âŒ é”™è¯¯</span> (æ­£ç¡®ç­”æ¡ˆ: ${correctOption}. ${qItem.options[qItem.correct]})`;
                    }
                } else {
                    resultEl.innerHTML = '<span class="text-yellow-600">âš ï¸ æœªä½œç­”</span>';
                }

                // Disable all options after checking
                document.querySelectorAll(`input[name="q${qIndex}"]`).forEach(input => {
                    input.disabled = true;
                });
            });

            document.getElementById('reading-result').textContent = `å¾—åˆ†: ${score} / ${total}`;
            document.getElementById('reading-check-btn').style.display = 'none';
        }

        function nextReading() {
            currentReadingIndex = (currentReadingIndex + 1) % readingQuizData.length;
            renderReadingQuiz();
        }

        // --- 8. Sentence Completion Logic (V) ---

        function renderCompletionQuiz() {
            const data = completionQuizData[currentCompletionIndex];
            const quizDisplay = document.getElementById('completion-quiz-display');
            
            // Display CN hint
            document.getElementById('completion-cn').textContent = `ä¸­æ–‡: ${data.cn}`;
            
            // Build the sentence display with blanks
            let html = '';
            let blankCounter = 0;

            data.en_parts.forEach(part => {
                if (part.startsWith('[')) {
                    // It's a blank
                    const correctWord = data.blanks[blankCounter].correct;
                    
                    html += `
                        <input type="text" 
                                class="border-2 border-gray-300 p-2 rounded-lg text-center focus:border-pink-500 focus:ring-0 blank" 
                                placeholder="è¾“å…¥ ${correctWord} (æç¤º)" 
                                value=""
                                >
                    `;
                    blankCounter++;
                } else {
                    // It's regular text
                    html += `<span>${part}</span>`;
                }
            });
            
            quizDisplay.innerHTML = html;
            document.getElementById('completion-result').innerHTML = '';
            document.getElementById('completion-check-btn').style.display = 'block';

            // Re-enable inputs
            quizDisplay.querySelectorAll('input').forEach(input => {
                input.disabled = false;
                input.classList.remove('border-green-500', 'border-red-500');
            });
        }

        function checkCompletion() {
            const data = completionQuizData[currentCompletionIndex];
            const quizDisplay = document.getElementById('completion-quiz-display');
            const inputs = quizDisplay.querySelectorAll('input');
            const result = document.getElementById('completion-result');
            let allCorrect = true;
            
            inputs.forEach((input, index) => {
                const userAnswer = input.value.trim().toLowerCase();
                const correctWord = data.blanks[index].correct.toLowerCase();
                
                input.disabled = true;

                if (userAnswer === correctWord) {
                    input.classList.add('border-green-500');
                    input.classList.remove('border-red-500');
                } else {
                    input.classList.add('border-red-500');
                    input.classList.remove('border-green-500');
                    allCorrect = false;
                }
            });
            
            // Construct and display the full correct sentence
            let finalSentenceParts = [];
            let blankCounter = 0;
            data.en_parts.forEach(part => {
                if (part.startsWith('[')) {
                    finalSentenceParts.push(data.blanks[blankCounter].correct);
                    blankCounter++;
                } else {
                    finalSentenceParts.push(part);
                }
            });
            
            const fullCorrectSentence = finalSentenceParts.join(' ');


            if (allCorrect) {
                result.innerHTML = `<span class="text-green-600">âœ… å…¨éƒ¨æ­£ç¡®ï¼</span> å®Œæ•´å¥å­ï¼š${fullCorrectSentence}`;
            } else {
                result.innerHTML = `<span class="text-red-600">âŒ å­˜åœ¨é”™è¯¯ã€‚</span> æ­£ç¡®å¥å­: ${fullCorrectSentence}`;
            }

            document.getElementById('completion-check-btn').style.display = 'none';
        }

        function nextCompletion() {
            currentCompletionIndex = (currentCompletionIndex + 1) % completionQuizData.length;
            renderCompletionQuiz();
        }

        // --- 9. Cloze Test Logic (VI) ---

        function renderClozeQuiz() {
            const data = clozeQuizData[currentClozeIndex];
            document.getElementById('cloze-title').textContent = data.title;
            document.getElementById('cloze-result').textContent = '';
            document.getElementById('cloze-check-btn').style.display = 'block';

            // 1. Render Passage
            const passageEl = document.getElementById('cloze-passage');
            let passageHtml = '';
            
            // Combine all text and blanks first, adding &nbsp; around blanks to prevent wrapping.
            const fullTextWithBlanks = data.textParts.map((part, index) => {
                if (index % 2 === 1) { // This is a blank word index (the expected answer)
                    // Insert the custom blank placeholder with number above underline
                    const qIndex = (index + 1) / 2;
                    return `
                        &nbsp;<span class="cloze-placeholder">
                            <span class="cloze-number">${qIndex}</span>
                            <span class="cloze-underline"></span>
                        </span>&nbsp;
                    `;
                } else {
                    return part;
                }
            }).join('');
            
            // Split into paragraphs using the new line marker \n\n and wrap each in <p>
            const paragraphs = fullTextWithBlanks.split('\n\n');
            passageHtml = paragraphs.map(p => {
                // Trim to remove potential leading/trailing spaces from split, and ensure only non-empty paragraphs are rendered
                const trimmedP = p.trim();
                return trimmedP ? `<p class="mb-6">${trimmedP}</p>` : '';
            }).join('');

            passageEl.innerHTML = passageHtml;


            // 2. Render Questions
            const questionsContainer = document.getElementById('cloze-questions-container');
            let questionsHtml = '';

            data.questions.forEach((qItem, qArrIndex) => {
                questionsHtml += `
                    <div class="p-4 bg-white rounded-lg shadow-sm border border-red-200">
                        <p class="font-bold mb-3 text-gray-800">${qItem.qIndex}. è¯·é€‰æ‹©æœ€åˆé€‚çš„å•è¯å¡«å…¥ç©ºç™½ (${qItem.qIndex}):</p>
                        <div class="cloze-options-row"> <!-- Use the new inline row class -->
                `;
                qItem.options.forEach((option, oIndex) => {
                    questionsHtml += `
                        <label>
                            <input type="radio" name="cloze-q${qItem.qIndex}" value="${oIndex}" data-qindex="${qArrIndex}">
                            <span>${String.fromCharCode(65 + oIndex)}. ${option}</span>
                        </label>
                    `;
                });
                questionsHtml += `
                        </div>
                        <p id="cloze-q-result-${qItem.qIndex}" class="mt-2 text-sm font-semibold"></p>
                    </div>
                `;
            });

            questionsContainer.innerHTML = questionsHtml;
        }

        function checkCloze() {
            const data = clozeQuizData[currentClozeIndex];
            let score = 0;
            let total = data.questions.length;

            data.questions.forEach((qItem) => {
                const selected = document.querySelector(`input[name="cloze-q${qItem.qIndex}"]:checked`);
                const resultEl = document.getElementById(`cloze-q-result-${qItem.qIndex}`);
                
                // Get the correct word to display in the result message (Index is qIndex * 2 - 1)
                const correctWord = data.textParts[qItem.qIndex * 2 - 1]; 

                if (selected) {
                    const userAnswer = parseInt(selected.value);
                    if (userAnswer === qItem.correct) {
                        score++;
                        resultEl.innerHTML = `<span class="text-green-600">âœ… æ­£ç¡®</span> (ç­”æ¡ˆ: ${correctWord})`;
                    } else {
                        const correctOption = String.fromCharCode(65 + qItem.correct);
                        resultEl.innerHTML = `<span class="text-red-600">âŒ é”™è¯¯</span> (æ­£ç¡®ç­”æ¡ˆ: ${qItem.options[qItem.correct]})`;
                    }
                } else {
                    resultEl.innerHTML = '<span class="text-yellow-600">âš ï¸ æœªä½œç­”</span>';
                }

                // Disable all options after checking
                document.querySelectorAll(`input[name="cloze-q${qItem.qIndex}"]`).forEach(input => {
                    input.disabled = true;
                });
            });

            document.getElementById('cloze-result').textContent = `å¾—åˆ†: ${score} / ${total}`;
            document.getElementById('cloze-check-btn').style.display = 'none';
        }

        function nextCloze() {
            currentClozeIndex = (currentClozeIndex + 1) % clozeQuizData.length;
            renderClozeQuiz();
        }

        // --- 10. Initialization ---
        window.onload = function() {
            showSection('vocab'); // Start on the vocabulary tab
            document.getElementById('vocab-card-container').addEventListener('click', flipVocab);
            
            // Initial render for all sections
            renderSentence();
            renderGrammarQuiz();
            renderReadingQuiz();
            renderCompletionQuiz();
            renderClozeQuiz(); 
        };

    </script>
</body>
</html>
